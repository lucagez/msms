{"version":3,"file":"msms.js","sources":["../src/prepareSchema.js","../src/errors.js","../src/proxy.js","../src/stores.js","../src/functions.js","../src/msms.js"],"sourcesContent":["const prepareSchema = (schema) => {\n  const state = {};\n  const usedSchema = {};\n\n  for (const prop in schema) {\n    const current = schema[prop];\n    if (prop === 'EFFECTS') continue;\n    if (typeof current === 'object') {\n      state[prop] = typeof current.default !== 'undefined'\n        ? current.default\n        : current.action({});\n\n      usedSchema[prop] = current;\n    } else {\n      state[prop] = current({});\n      usedSchema[prop] = { action: current };\n    }\n  }\n\n  usedSchema.EFFECTS = schema.EFFECTS;\n\n  return {\n    state,\n    usedSchema,\n    props: Object.keys(state),\n  };\n};\n\nexport default prepareSchema;\n","const errors = {\n  prop: (obj, prop) => {\n    if (typeof obj[prop] === 'undefined' && prop !== 'EFFECTS') {\n      throw new Error(`${prop} is not a prop`);\n    }\n  },\n\n  store: (obj, name) => {\n    if (typeof obj === 'undefined') {\n      throw new Error(`${name} is not a store`);\n    }\n  },\n\n  alloweds: (obj, alloweds) => {\n    if (alloweds) {\n      alloweds\n        .forEach((allowed) => {\n          if (typeof obj.schema[allowed] === 'undefined') {\n            throw new Error(`${allowed} is not a prop`);\n          }\n        });\n    }\n  },\n};\n\nexport default errors;\n","/**\n * `proxy` will create a new dynamic proxy that\n * will make read-only ANY object passed into it.\n * => Every state callback will always return a proxy.\n * This will result in making the state only internally\n * mutable via previously defined `send` actions.\n *\n * NOTE: The proxy is create only one time at store creation\n * and the same instance of the proxy will be used for\n * interactions with the external API.\n * This approach will be way faster and will expose way less overhead\n * than creating a new `Object.freeze()` object on each\n * user facing action.\n *\n * @param {object} obj\n * Object taken as reference for creating a new deep Proxy\n *\n * @return {Proxy}\n * User facing proxied state. A read-only reference to the internal state.\n */\nconst proxy = (obj) => {\n  // Recycling proxies.\n  // Using a WeakMap to allow proxies to be garbage collected.\n  const proxies = new WeakMap();\n\n  const descriptor = {\n    get(target, prop) {\n      const value = target[prop];\n      let tempProxy = proxies.get(value);\n\n      if (typeof value === 'object' && !tempProxy) {\n        tempProxy = new Proxy(value, descriptor);\n        proxies.set(value, tempProxy);\n      }\n\n      return tempProxy || value;\n    },\n    // Empty set property.\n    // => The resulting object will be a read only\n    // copy.\n    // => Way faster than freezing.\n    set() { },\n  };\n\n  return new Proxy(obj, descriptor);\n};\n\nexport default proxy;\n","const stores = new Map();\n\nexport default stores;\n","import errors from './errors';\nimport proxy from './proxy';\n\nconst _send = (store) => {\n  const { schema } = store;\n  const proxied = proxy(store.state);\n\n  return (prop, arg) => {\n    errors.prop(schema, prop);\n\n    if (prop === 'EFFECTS') return schema.EFFECTS[arg](proxied, store.send);\n\n    const { validate, action } = schema[prop];\n\n    const state = action(proxied, arg);\n\n    if (validate && !validate(state)) return false;\n    if (store.state[prop] === state) return false;\n\n    store.state[prop] = state;\n\n    // Using slower forEach because of transpilation problems.\n    // However, you cannot load so much elements in a webpage to\n    // outgrow it's speed.\n\n    // => as the dispatch is O(n)\n    store.funcs.forEach((list, func) => {\n      if (list.has(prop)) {\n        func({ ...proxied });\n      }\n    });\n\n    return true;\n  };\n};\n\n\nconst _on = (store, props) => (func) => {\n  if (store.funcs.has(func)) return;\n\n  store.funcs.set(func, new Set(props || store.props));\n};\n\n\nconst _off = store => (func) => {\n  store.funcs.delete(func);\n};\n\nexport {\n  _send,\n  _on,\n  _off,\n};\n","import prepareSchema from './prepareSchema';\nimport errors from './errors';\nimport proxy from './proxy';\nimport stores from './stores';\nimport {\n  _send,\n  _on,\n  _off,\n} from './functions';\n\nconst create = (name, schema) => {\n  const { state, props, usedSchema } = prepareSchema(schema);\n\n  const store = {\n    state,\n    props,\n    schema: usedSchema,\n    queue: [],\n    funcs: new Map(),\n  };\n\n  store.send = _send(store);\n\n  stores.set(name, store);\n};\n\nconst get = (name) => {\n  const store = stores.get(name);\n\n  errors.store(store, name);\n\n  return proxy(store.state);\n};\n\nconst use = (name, alloweds) => {\n  const store = stores.get(name);\n\n  errors.store(store, name);\n  errors.alloweds(store, alloweds);\n\n  return [\n    _send(store),\n    proxy(store.state),\n    _on(store, alloweds),\n    _off(store),\n  ];\n};\n\nconst destroy = name => stores.delete(name);\n\nexport {\n  create,\n  use,\n  get,\n  destroy,\n};\n"],"names":["const","prepareSchema","schema","state","usedSchema","prop","current","default","action","EFFECTS","props","Object","keys","errors","obj","Error","store","name","alloweds","forEach","allowed","proxy","proxies","WeakMap","descriptor","get","target","value","tempProxy","Proxy","set","stores","Map","_send","proxied","arg","send","validate","funcs","list","func","has","_on","Set","_off","delete","create","queue","use","destroy"],"mappings":"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"}