{"version":3,"file":"msms.js","sources":["../src/prepareSchema.js","../src/errors.js","../src/stores.js","../src/functions.js","../src/msms.js"],"sourcesContent":["const prepareSchema = (schema) => {\n  const state = {};\n  const usedSchema = {};\n\n  for (const prop in schema) {\n    const current = schema[prop];\n    if (typeof current === 'object') {\n      state[prop] = typeof current.default !== 'undefined'\n        ? current.default\n        : current.action({});\n\n      usedSchema[prop] = current;\n    } else {\n      state[prop] = current({});\n      usedSchema[prop] = { action: current };\n    }\n  }\n\n  return {\n    state,\n    usedSchema,\n    props: Object.keys(state),\n  };\n};\n\nexport default prepareSchema;\n","const errors = {\n  prop: (obj, prop) => {\n    if (typeof obj === 'undefined') {\n      throw new Error(`${prop} is not a prop`);\n    }\n  },\n\n  store: (obj, name) => {\n    if (typeof obj === 'undefined') {\n      throw new Error(`${name} is not a store`);\n    }\n  },\n\n  alloweds: (obj, alloweds) => {\n    if (alloweds) {\n      alloweds\n        .forEach((allowed) => {\n          if (typeof obj.schema[allowed] === 'undefined') {\n            throw new Error(`${allowed} is not a prop`);\n          }\n        });\n    }\n  },\n};\n\nexport default errors;\n","const stores = new Map();\n\nexport default stores;\n","import errors from './errors';\n\n// Empty set property.\n// => The resulting object will be a read only\n// copy.\n// => Way fater than freezing.\nconst makeProxy = obj => new Proxy(obj, {\n  set() { },\n});\n\nconst _send = (store) => {\n  const proxied = makeProxy(store.state);\n\n  return (prop, arg) => {\n    const { length } = store.queue;\n    const current = store.schema[prop];\n\n    errors.prop(current, prop);\n\n    const { validate, action } = current;\n\n    const state = action(proxied, arg);\n\n    if (validate && !validate(state)) return false;\n    if (store.state[prop] === state) return false;\n\n    store.state[prop] = state;\n\n    // Dispatching in O(n) time üòç\n    for (let i = 0; i < length; i++) {\n      const { list, func } = store.queue[i];\n\n      if (list.has(prop)) {\n        func(proxied);\n      }\n    }\n\n    return true;\n  };\n};\n\n\nconst _on = (store, props) => (func) => {\n  if (store.funcs.has(func)) return;\n\n  store.queue.push({\n    func,\n    list: new Set(props || store.props),\n  });\n};\n\n\nconst _off = store => (func) => {\n  store.funcs.delete(func);\n  store.queue = store.queue\n    .filter(({ func: current }) => func !== current);\n};\n\nexport {\n  _send,\n  _on,\n  _off,\n};\n","import prepareSchema from './prepareSchema';\nimport errors from './errors';\nimport stores from './stores';\nimport {\n  _send,\n  _on,\n  _off,\n} from './functions';\n\n\nconst makeProxy = obj => new Proxy(obj, {\n  set() { },\n});\n\nconst create = (name, schema) => {\n  const { state, props, usedSchema } = prepareSchema(schema);\n\n  const store = {\n    state,\n    props,\n    schema: usedSchema,\n    queue: [],\n    funcs: new Set(),\n  };\n\n  state.send = _send(store);\n\n  stores.set(name, store);\n};\n\nconst get = (name) => {\n  const store = stores.get(name);\n\n  errors.store(store, name);\n\n  return makeProxy(store.state);\n};\n\nconst use = (name, alloweds) => {\n  const store = stores.get(name);\n\n  errors.store(store, name);\n  errors.alloweds(store, alloweds);\n\n  return [\n    _send(store),\n    _on(store, alloweds),\n    _off(store),\n    makeProxy(store.state),\n  ];\n};\n\nconst destroy = name => stores.delete(name);\n\nexport {\n  create,\n  use,\n  get,\n  destroy,\n};\n"],"names":["const","prepareSchema","schema","state","usedSchema","prop","current","default","action","props","Object","keys","errors","obj","Error","store","name","alloweds","forEach","allowed","stores","Map","makeProxy","Proxy","set","_send","proxied","arg","queue","length","validate","let","i","list","func","has","_on","funcs","push","Set","_off","delete","filter","create","send","get","use","destroy"],"mappings":"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"}